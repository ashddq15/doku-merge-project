<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>DOKU CMCI ‚Äì Seasonal Recommendations</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root{
      --bg:#0f0f12;--card:#16161a;--line:#2a2a2f;--text:#eaeaea;--muted:#b8b8bd;--red:#e11d48;--green:#22c55e
    }
    *{box-sizing:border-box}
    body{font-family:ui-sans-serif,system-ui,Arial;margin:32px;background:var(--bg);color:var(--text)}
    h1{margin:0 0 16px}
    h3{margin:0 0 12px}
    a{color:#93c5fd;text-decoration:none}
    /* table */
    table{border-collapse:collapse;width:100%;background:var(--card);border-radius:12px;overflow:hidden}
    th,td{padding:12px 14px;border-bottom:1px solid var(--line);text-align:left}
    th{position:relative}
    tbody tr:hover{background:#1e1e25;cursor:pointer}
    /* cards & layout */
    .card{background:var(--card);padding:16px;border-radius:16px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin-top:16px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .muted{color:var(--muted)}
    /* buttons & badges */
    .btn{background:var(--red);color:#fff;border:none;padding:10px 16px;border-radius:10px;font-weight:600}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#232329;border:1px solid var(--line);
          padding:6px 10px;border-radius:999px;margin-right:6px;font-size:12px}
    .pill.good{border-color:#1f6f47}
    /* tooltip */
    .tip{display:inline-block;margin-left:6px;background:#232329;border:1px solid var(--line);
         width:16px;height:16px;line-height:16px;text-align:center;border-radius:999px;font-size:11px;color:#bdbdc4}
    .tip:hover + .tooltip{opacity:1;transform:translateY(0)}
    .tooltip{position:absolute;z-index:5;top:140%;left:0;width:260px;background:#111216;border:1px solid #2b2b33;
             padding:10px;border-radius:10px;color:#cfcfd6;font-size:12px;opacity:0;transition:.2s;transform:translateY(-6px)}
    /* merchant detail */
    .cols{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px}
    .block{border:1px solid var(--line);border-radius:12px;padding:12px}
    .label{font-size:12px;color:var(--muted);margin-bottom:4px}
    .kpi{font-weight:700}
    .list{margin:0;padding-left:18px}
    .spark{display:flex;gap:2px;margin-top:6px}
    .bar{height:24px;width:4px;border-radius:2px;background:#2a2a2f}
    .bar.on{background:#3b3b45}
    /* selects */
    select{background:#232329;color:#eaeaea;border:1px solid var(--line);padding:8px 10px;border-radius:8px}

    /* ===== Insight pretty layout ===== */
    #insightBox{line-height:1.5}
    .insight .lead{font-weight:600;margin-bottom:10px}
    .insight .para{margin:6px 0}
    .insight .idea{border:1px solid var(--line);border-radius:12px;padding:10px;margin:10px 0;background:#15151b}
    .insight .idea-title{font-weight:700;margin-bottom:6px}
    .insight ul{margin:0;padding-left:18px}
    .insight li{margin:4px 0}
    .insight .note{color:var(--muted);margin-top:8px;font-size:13px}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}

    /* ===== Tambahan UI: AI Auto Insights (tidak mengubah style lama) ===== */
    .tab-section{margin-top:24px}
    .tab-section table{width:100%;border-collapse:collapse;background:var(--card);border-radius:12px}
    .tab-section th,.tab-section td{padding:10px 12px;border-bottom:1px solid var(--line);vertical-align:top}
    .tab-section th{color:var(--muted);text-align:left}
  </style>
</head>
<body>
  <div class="top">
    <h1>Cross-Merchant Recommendations</h1>
    <div class="row">
      <label class="muted">Season&nbsp;</label>
      <select id="seasonSel">
        <option value="auto">Auto (current)</option>
        <option value="all">All (30d baseline)</option>
      </select>
      <span id="seasonBadge" class="pill"></span>
    </div>
  </div>

  <!-- TABEL REKOMENDASI -->
  <div class="card">
    <table id="tbl">
      <thead>
        <tr>
          <th>#</th>
          <th>Merchant 1</th>
          <th>Merchant 2</th>
          <th>
            Score
            <span class="tip">i</span>
            <div class="tooltip">
              <b>Score</b> adalah nilai gabungan untuk menentukan prioritas kolaborasi.
              Di MVP ini nilainya = <i>Jaccard 30d</i>. Pada versi penuh, Score akan
              menggabungkan:<br/>‚Ä¢ Overlap user (Jaccard)<br/>‚Ä¢ Perbedaan jam puncak (seasonality)<br/>‚Ä¢ Perbedaan channel (synergy)<br/>‚Ä¢ Risiko kegagalan (fail risk).
            </div>
          </th>
          <th>
            Jaccard 30d
            <span class="tip">i</span>
            <div class="tooltip">
              <b>Jaccard 30d</b> mengukur irisan pengguna kedua merchant selama 30 hari:
              <br/><code class="mono">|A ‚à© B| / (|A| + |B| ‚àí |A ‚à© B|)</code><br/>
              Semakin besar nilainya, semakin banyak pengguna yang sama di kedua merchant.
            </div>
          </th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- PANEL BAWAH -->
  <div class="grid">
    <div class="card">
      <div class="top">
        <h3 id="pairTitle">Pair Detail</h3>
        <div id="tags"></div>
      </div>

      <div class="row" style="margin-bottom:12px">
        <select id="horizonSel" style="background:#232329;color:#eaeaea;border:1px solid #2a2a2f;padding:10px 12px;border-radius:10px">
          <option value="next_month">Next month</option>
          <option value="next_week">Next week</option>
        </select>
        <button id="aiInsightBtn" class="btn" disabled>Generate AI Insight</button>
        <button id="insightBtn" class="btn" disabled>Generate (Rule) Insight</button>
        <button id="downloadBtn" class="btn" disabled>Download Audience CSV</button>
        <span class="muted">Pilih baris di tabel untuk mengaktifkan tombol.</span>
      </div>

      <!-- DETAIL TERFORMAT -->
      <div class="cols" id="detailCols" style="display:none">
        <div class="block">
          <div class="label">Merchant A</div>
          <div class="kpi" id="aName">-</div>
          <div class="label" style="margin-top:8px">Peak Hours (Top 3)</div>
          <ul class="list" id="aHours"></ul>
          <div class="label" style="margin-top:8px">Channel Share</div>
          <ul class="list" id="aChannels"></ul>
          <div class="label" style="margin-top:8px">Distribusi Jam (24)</div>
          <div id="aSpark" class="spark"></div>
        </div>
        <div class="block">
          <div class="label">Merchant B</div>
          <div class="kpi" id="bName">-</div>
          <div class="label" style="margin-top:8px">Peak Hours (Top 3)</div>
          <ul class="list" id="bHours"></ul>
          <div class="label" style="margin-top:8px">Channel Share</div>
          <ul class="list" id="bChannels"></ul>
          <div class="label" style="margin-top:8px">Distribusi Jam (24)</div>
          <div id="bSpark" class="spark"></div>
        </div>
      </div>

      <!-- INSIGHT -->
      <div id="insightBox" class="block" style="margin-top:12px;display:none">
        <div id="insightTitle" class="label">Insight</div>
        <div id="insightText">-</div>
      </div>
    </div>

    <div class="card">
      <h3>How to use</h3>
      <ol>
        <li>Pilih <b>Season</b> (Auto = season aktif; All = baseline 30 hari; atau pilih manual).</li>
        <li>Klik baris rekomendasi ‚Üí lihat ringkasan detail & insight.</li>
        <li>Gunakan <b>Generate AI Insight</b> untuk ide kampanye <i>next week/month</i> berbasis data.</li>
        <li>Tekan <b>Download Audience CSV</b> untuk user A yang belum belanja di B.</li>
      </ol>
      <p class="muted">Seasonal mode menghitung overlap hanya di rentang tanggal musim tersebut.</p>
    </div>
  </div>

  <!-- ===== Tambahan: AI Auto Insights (fitur baru, tidak mengubah yang lama) ===== -->
  <div class="tab-section card">
    <div class="top">
      <h3>üß† AI Auto Insights</h3>
      <button class="btn" onclick="loadAutoInsights()">Refresh</button>
    </div>
    <table id="tblAuto">
      <thead>
        <tr><th>Merchant 1</th><th>Merchant 2</th><th>Season</th><th>Insight</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- ====== GEO-BASED RECOMMENDATIONS (DITAMBAHKAN DI BAWAH INSIGHT) ====== -->
  <div class="tab-section card">
    <div class="top">
      <h3>üìç Geo-based Recommendations</h3>
      <div class="row">
        <label class="muted">City&nbsp;</label>
        <select id="citySel">
          <option value="Jakarta">Jakarta</option>
          <option value="Bandung">Bandung</option>
          <option value="Surabaya">Surabaya</option>
          <option value="Medan">Medan</option>
          <option value="Denpasar">Denpasar</option>
        </select>
        <button class="btn" id="geoRefreshBtn">Refresh</button>
      </div>
    </div>
    <table id="tblGeo">
      <thead>
        <tr>
          <th>#</th>
          <th>Merchant 1</th>
          <th>Merchant 2</th>
          <th>Geo Score</th>
          <th>Distance (km)</th>
          <th>City</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="merge-chat-btn" style="
  position: fixed; bottom: 20px; right: 20px;
  background: #e11d48; color: white;
  border-radius: 50%; width: 55px; height: 55px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; box-shadow: 0 3px 10px rgba(0,0,0,0.3);
">
  üí¨
</div>

<!-- Chat Window -->
<div id="merge-chat-window" style="
  display: none; position: fixed; bottom: 90px; right: 20px;
  width: 320px; height: 400px; background: white;
  border-radius: 12px; box-shadow: 0 3px 10px rgba(0,0,0,0.2);
  overflow: hidden; flex-direction: column;
  font-family: 'Inter', sans-serif;
">
  <div style="background:#e11d48; color:white; padding:10px;">
    <strong>MERGE AI</strong> ü§ñ
  </div>

  <!-- Area pesan -->
  <div id="chat-body" style="
    flex:1; padding:10px; overflow-y:auto;
    font-size:14px; color:#111; background:#fff;
  "></div>

  <!-- Input -->
  <div style="display:flex; border-top:1px solid #ccc;">
    <input id="chat-input" placeholder="Tanyakan ke Merge..." 
      style="flex:1; border:none; padding:10px; color:#111; outline:none;">
    <button id="chat-send"
      style="background:#e11d48; color:white; border:none;
      padding:10px 14px; cursor:pointer;">Kirim</button>
  </div>
</div>

<script>
  const btn   = document.getElementById('merge-chat-btn');
const win   = document.getElementById('merge-chat-window');
const body  = document.getElementById('chat-body');
const input = document.getElementById('chat-input');
const send  = document.getElementById('chat-send');

function addMsg(text, who='user') {
  const div = document.createElement('div');
  div.className = who === 'user'
    ? 'chat-row user'
    : 'chat-row bot';
  // bold markdown mini
  div.innerHTML = text
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\n/g,'<br>');
  body.appendChild(div);
  body.scrollTop = body.scrollHeight;
}

function addTyping() {
  const d = document.createElement('div');
  d.className = 'chat-row bot typing';
  d.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
  body.appendChild(d);
  body.scrollTop = body.scrollHeight;
  return d;
}
function addHints(hints) {
  if (!hints || !hints.length) return;
  const wrap = document.createElement('div');
  wrap.className = 'hint-wrap';
  hints.forEach(h=>{
    const b = document.createElement('button');
    b.className = 'hint';
    b.textContent = h;
    b.onclick = ()=> { input.value = h; send.click(); };
    wrap.appendChild(b);
  });
  body.appendChild(wrap);
  body.scrollTop = body.scrollHeight;
}

async function ask(q) {
  addMsg(q, 'user');
  const typing = addTyping();
  try {
    const r = await fetch('/chat', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({text: q})
    });
    const data = await r.json();
    typing.remove();
    addMsg(data.reply || '(tanpa balasan)', 'bot');
    addHints(data.hints);
  } catch(e) {
    typing.remove();
    addMsg('Maaf, jaringan lagi bermasalah. Coba lagi ya.', 'bot');
  }
}

btn.onclick = ()=> win.style.display = (win.style.display==='none'?'flex':'none');
send.onclick = ()=> {
  const q = (input.value||'').trim();
  if (!q) return;
  input.value = '';
  ask(q);
};
input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ send.click(); }});

// gaya kecil
const css = document.createElement('style');
css.textContent = `
.chat-row{margin:8px 0; line-height:1.4}
.chat-row.user{ text-align:right; }
.chat-row.user{ color:#111 }
.chat-row.bot{ color:#222 }
.hint-wrap{ margin-top:6px; display:flex; gap:6px; flex-wrap:wrap }
.hint{ background:#ffe2e6; border:1px solid #e11d48; color:#b10e31; border-radius:999px; padding:4px 10px; font-size:12px; cursor:pointer }
.hint:hover{ background:#ffd4db }
.typing .dot{ display:inline-block; width:6px; height:6px; margin:0 2px; border-radius:50%; background:#999; animation:b 1s infinite alternate }
.typing .dot:nth-child(2){ animation-delay:.2s }
.typing .dot:nth-child(3){ animation-delay:.4s }
@keyframes b { from{opacity:.3; transform:translateY(0)} to{opacity:1; transform:translateY(-2px)} }
`;
document.head.appendChild(css);
const API = location.origin.replace(/\/app$/, ''); // base API
let NEXT_HOLIDAY = null;

function percent(x){ return (Number(x||0)*100).toFixed(1) + '%' }
function top3Hours(arr){
  if(!arr || !arr.length) return []
  const tmp = arr.map((v,i)=>({h:i,v:+v||0})).sort((a,b)=>b.v-a.v).slice(0,3);
  return tmp.map(x=>`${x.h}:00 (${percent(x.v)})`);
}
function fillList(ul, items){
  ul.innerHTML = ''; items.forEach(t=>{const li=document.createElement('li');li.textContent=t;ul.appendChild(li);});
}
function spark(container, arr){
  container.innerHTML = '';
  const max = Math.max(...arr.map(x=>+x||0), 0.0001);
  arr.forEach(v=>{
    const b=document.createElement('div'); b.className='bar on';
    b.style.height = (8 + (v/max)*24)+'px';
    container.appendChild(b);
  });
}
function pills(meta){
  const wrap = document.getElementById('tags');
  wrap.innerHTML = '';
  if(!meta) return;
  const mk = (t, good=false)=>{const s=document.createElement('span');s.className='pill'+(good?' good':'');s.textContent=t;return s;}
  wrap.appendChild(mk(`Score ${Number(meta.score||0).toFixed(4)}`, true));
  wrap.appendChild(mk(`Jaccard ${Number(meta.jac||0).toFixed(4)}`));
}

async function loadSeasons(){
  const res = await fetch(`${API}/seasons`);
  const j = await res.json();
  const sel = document.getElementById('seasonSel');
  (j.seasons||[]).forEach(s=>{
    const opt = document.createElement('option');
    opt.value = `custom:${s.season_name}`;
    opt.textContent = s.season_name;
    sel.appendChild(opt);
  });
  const badge = document.getElementById('seasonBadge');
  if (j.current){
    badge.textContent = `Current: ${j.current.season_name} (${j.current.start_date} ‚Üí ${j.current.end_date})`;
    sel.value = 'auto';
  } else {
    badge.textContent = 'No current season';
    sel.value = 'all';
  }
}

async function loadNextHoliday(){
  try{
    const r = await fetch(`${API}/next_holiday`);
    if(r.ok) NEXT_HOLIDAY = await r.json();
    else NEXT_HOLIDAY = null;
  }catch{ NEXT_HOLIDAY = null; }
}
function holidayLine(){
  if(!NEXT_HOLIDAY) return '';
  const d = NEXT_HOLIDAY;
  return ` ‚Äî Next holiday: ${d.holi_name} (${d.holi_date}) D-${d.days_left}`;
}

async function loadRecs(){
  const sel = document.getElementById('seasonSel').value;
  let url = `${API}/recommendations?top=5`;  
  if (sel === 'auto') url += `&mode=auto`;
  else if (sel === 'all') url += `&mode=all`;
  else if (sel.startsWith('custom:')){
    const name = encodeURIComponent(sel.split(':')[1]);
    url += `&mode=custom&season=${name}`;
  }
  const r = await fetch(url);
  const j = await r.json();
  const data = j.rows || j || [];
  const tb = document.querySelector('#tbl tbody');
  tb.innerHTML = '';
  data.forEach((rec,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${rec.m1_name}</td>
      <td>${rec.m2_name}</td>
      <td>${Number(rec.score).toFixed(4)}</td>
      <td>${Number(rec.jaccard_30d).toFixed(4)}</td>`;
    tr.onclick = ()=> showDetail(rec.m1, rec.m1_name, rec.m2, rec.m2_name);
    tb.appendChild(tr);
  });
}

let currentPair = null;

async function showDetail(m1, m1n, m2, m2n) {
  currentPair = {m1, m1n, m2, m2n};
  document.getElementById('insightBox').style.display='none';
  const res = await fetch(`${API}/pair/${m1}/${m2}/detail`);
  const d = await res.json();

  document.getElementById('pairTitle').innerText = `${d.m1.name} √ó ${d.m2.name}`;
  pills({score:d.metrics.score, jac:d.metrics.jaccard_30d});

  // isi kolom A
  document.getElementById('aName').textContent = d.m1.name;
  fillList(document.getElementById('aHours'), top3Hours(d.m1.hour_hist));
  const aCh = Object.entries(d.m1.channel_share||{}).map(([k,v])=>`${k}: ${percent(v)}`);
  fillList(document.getElementById('aChannels'), aCh);
  spark(document.getElementById('aSpark'), (d.m1.hour_hist||[]).map(Number));

  // isi kolom B
  document.getElementById('bName').textContent = d.m2.name;
  fillList(document.getElementById('bHours'), top3Hours(d.m2.hour_hist));
  const bCh = Object.entries(d.m2.channel_share||{}).map(([k,v])=>`${k}: ${percent(v)}`);
  fillList(document.getElementById('bChannels'), bCh);
  spark(document.getElementById('bSpark'), (d.m2.hour_hist||[]).map(Number));

  document.getElementById('detailCols').style.display='grid';
  document.getElementById('downloadBtn').disabled = false;
  document.getElementById('insightBtn').disabled = false;
  document.getElementById('aiInsightBtn').disabled = false;
}

async function downloadCSV() {
  if (!currentPair) return;
  const res = await fetch(`${API}/audience?m1=${currentPair.m1}&m2=${currentPair.m2}&winA=30d&winB=90d`);
  const j = await res.json();
  const rows = ['user_hash', ...j.users].join('\n');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([rows], {type:'text/csv'}));
  a.download = `${currentPair.m1n || currentPair.m1}__to__${currentPair.m2n || currentPair.m2}_audience.csv`;
  a.click();
}

/* ======== INSIGHT RENDERER (rapi & mudah dibaca) ======== */
function boldify(s){
  return s.replace(/\*\*(.+?)\*\*/g, '<b>$1</b>');
}
function renderInsight(text){
  const out = document.getElementById('insightText');
  const lines = (text || '').split('\n').map(l=>l.trim()).filter(Boolean);
  let html = '<div class="insight">';
  let i = 0;

  if(lines.length){
    html += `<div class="lead">${boldify(lines[0])}</div>`;
    i = 1;
  }

  let openUl = false;
  let insideIdea = false;

  const closeList = () => {
    if(openUl){ html += '</ul>'; openUl=false; }
    if(insideIdea){ html += '</div>'; insideIdea=false; }
  };

  for(; i<lines.length; i++){
    const l = lines[i];

    if(/^Catatan:/i.test(l)){
      closeList();
      html += `<div class="note">${boldify(l)}</div>`;
      continue;
    }

    const m = l.match(/^(\d+)\)\s+\*\*(.+?)\*\*/);
    if(m){
      closeList();
      html += `<div class="idea"><div class="idea-title">${m[1]}. ${boldify(m[2])}</div>`;
      html += `<ul>`;
      openUl = true; insideIdea = true;
      continue;
    }

    let b = l.match(/^‚Ä¢\s*(.+)$/) || l.match(/^-+\s*(.+)$/);
    if(b){
      if(!openUl){ html += '<ul>'; openUl=true; }
      html += `<li>${boldify(b[1])}</li>`;
      continue;
    }

    closeList();
    html += `<div class="para">${boldify(l)}</div>`;
  }
  closeList();
  html += '</div>';
  out.innerHTML = html;
}
/* ======================================================= */

async function showInsight(){
  if(!currentPair) return;
  const r = await fetch(`${API}/insight/${currentPair.m1}/${currentPair.m2}`);
  const j = await r.json();
  const box = document.getElementById('insightBox');
  const title = document.getElementById('insightTitle');
  title.textContent = 'Rule Insight' + holidayLine();
  renderInsight(j.idea || 'Tidak ada insight.');
  box.style.display = 'block';
}

async function showAIInsight(){
  if(!currentPair) return;
  const hz = document.getElementById('horizonSel').value || 'next_month';
  const r = await fetch(`${API}/ai_insight/${currentPair.m1}/${currentPair.m2}?horizon=${hz}`);
  const j = await r.json();
  const box = document.getElementById('insightBox');
  const title = document.getElementById('insightTitle');
  title.textContent = `AI Insight (${hz.replace('_',' ')})` + holidayLine();
  renderInsight(j.insight || 'AI insight belum tersedia.');
  box.style.display = 'block';
}

/* ===== Tambahan fungsi baru untuk tabel AI Auto Insights ===== */
async function loadAutoInsights(){
  try{
    const res = await fetch(`${API}/auto_insights`);
    const data = await res.json();
    const tb = document.querySelector('#tblAuto tbody');
    tb.innerHTML = '';
    (data||[]).forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.m1_name}</td><td>${r.m2_name}</td><td>${r.season||'-'}</td><td>${r.insight||''}</td>`;
      tb.appendChild(tr);
    });
  }catch(e){
    console.error('loadAutoInsights error', e);
  }
}

/* ====== GEO: loader sederhana (tidak mengubah flow lama) ====== */
async function loadGeoRecs(){
  const city = document.getElementById('citySel').value;
  const tb = document.querySelector('#tblGeo tbody');
  tb.innerHTML = '<tr><td colspan="6">Loading...</td></tr>';
  try{
    const r = await fetch(`${API}/geo/recommendations?city=${encodeURIComponent(city)}&top=5`);
    const data = await r.json();
    tb.innerHTML = '';
    (data || []).forEach((rec,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${rec.m1_name}</td>
        <td>${rec.m2_name}</td>
        <td>${Number(rec.geo_score ?? rec.score ?? 0).toFixed(4)}</td>
        <td>${Number(rec.distance_km ?? 0).toFixed(1)}</td>
        <td>${rec.m1_city || '-'}</td>`;
      // klik baris geo juga buka Pair Detail yg sama
     // tr.onclick = ()=> showDetail(rec.m1, rec.m1_name, rec.m2, rec.m2_name);
     tr.onclick = ()=> showDetail(rec.m1,rec.m1_name,rec.m2,rec.m2_name);
      tb.appendChild(tr);
    });
  }catch(e){
    console.error('loadGeoRecs error', e);
    tb.innerHTML = '<tr><td colspan="6">Gagal memuat data.</td></tr>';
  }
}

document.getElementById('seasonSel').onchange = loadRecs;
document.getElementById('downloadBtn').onclick = downloadCSV;
document.getElementById('insightBtn').onclick = showInsight;      // rule-based
document.getElementById('aiInsightBtn').onclick = showAIInsight;  // LLM-based
document.getElementById('geoRefreshBtn').onclick = loadGeoRecs;

(async function init(){
  await loadSeasons();
  await loadRecs();
  await loadNextHoliday();
  // Geo section manual (user klik Refresh)
})();
</script>
</body>
</html>
